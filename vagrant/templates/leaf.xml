<configuration>
    <system>
        <host-name>{{ host_name  }}</host-name>
    </system>
    <interfaces>
        {% for i in host.interfaces %}
        <interface replace="replace">
            <name>{{ i.interface }}</name>
            <description>{{ i.description }}</description>
            <mtu>{{ i.mtu }}</mtu>
            {% if i.family == 'inet' %}
            {% for u in i.units %}
            <unit>
                <name>{{ u.number }}</name>
                <family>
                    <inet>
                        <mtu>{{ u.mtu }}</mtu>
                        <address>
                            <name>{{ u.ip_address }}</name>
                        </address>
                    </inet>
                </family>
            </unit>
            {% endfor %}
            {% elif i.family == 'ethernet-switching' %}
            {% for u in i.units %}
            <unit>
                <name>{{ u.number }}</name>
                <family>
                    <ethernet-switching>
                        <interface-mode>{{ u.mode }}</interface-mode>
                        <vlan>
                            <members>{{ u.vlans }}</members>
                        </vlan>
                    </ethernet-switching>
                </family>
            </unit>
            {% endfor %}
            {% endif %}
        </interface>
        {% endfor %}
        <interface>
            <name>lo0</name>
            <unit>
                <name>0</name>
                <family>
                    <inet>
                        <address>
                            <name>{{ host.loopback.ip_address }}</name>
                        </address>
                    </inet>
                </family>
            </unit>
        </interface>
    </interfaces>
    <routing-options>
        <router-id>{{ host.loopback.ip_address.split('/')[0] }}</router-id>
        <autonomous-system>
            <as-number>{{ host.local_as }}</as-number>
        </autonomous-system>
        <forwarding-table>
            <export>PFE-LB</export>
        </forwarding-table>
    </routing-options>
    <policy-options>
        <policy-statement>
            <name>PFE-LB</name>
            <then>
                <load-balance>
                    <per-packet />
                </load-balance>
            </then>
        </policy-statement>
        <policy-statement>
            <name>fabric-out</name>
            <term>
                <name>direct</name>
                <from>
                    <protocol>direct</protocol>
                </from>
                <then>
                    <next-hop>
                        <self/>
                    </next-hop>
                    <accept/>
                </then>
            </term>
        </policy-statement>
    </policy-options>
    <protocols>
        <bgp>
            <log-updown />
            <graceful-restart></graceful-restart>
            <export>fabric-out</export>
            {% for g in host.protocols.bgp.groups %}
            <group>
                <name>{{ g.name }}</name>
                <type>{{ g.type }}</type>
                <mtu-discovery />
                <multipath>
                    <multiple-as />
                </multipath>
                {% for n in g.neighbors %}
                <neighbor>
                    <name>{{ n.name }}</name>
                    <peer-as>{{ n.peer_as }}</peer-as>
                </neighbor>
                {% endfor %}
            </group>
            {% endfor %}
        </bgp>
        <pim>
            <rp>
                <static>
                    <address>
                        <name>{{ host.protocols.pim.rp_address }}</name>
                    </address>
                </static>
            </rp>
            <interface>
                <name>all</name>
            </interface>
            <interface>
                <name>em0.0</name>
                <disable/>
            </interface>
        </pim>
    </protocols>
    <switch-options>
        <vtep-source-interface>
            <interface-name>lo0.0</interface-name>
        </vtep-source-interface>
    </switch-options>
    <vlans>
        {% for v in host.vlans %}
        <vlan>
            <name>{{ v.name }}</name>
            <vlan-id>{{ v.vlan_id }}</vlan-id>
            <vxlan>
                <vni>{{ v.vni }}</vni>
                <multicast-group>{{ v.multicast_group }}</multicast-group>
            </vxlan>
        </vlan>
        {% endfor %}
    </vlans>    
</configuration>
