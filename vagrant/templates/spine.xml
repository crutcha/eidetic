<configuration>
    <system>
        <host-name>{{ host_name  }}</host-name>
    </system>
    <interfaces>
        {% for i in host.interfaces %}
        <interface replace="replace">
            <name>{{ i.interface }}</name>
            <description>{{ i.description }}</description>
            <mtu>{{ i.mtu }}</mtu>
            {% for u in i.units %}
            <unit>
                <name>{{ u.number }}</name>
                <family>
                    <inet>
                        <mtu>{{ u.mtu }}</mtu>
                        <address>
                            <name>{{ u.ip_address }}</name>
                        </address>
                    </inet>
                </family>
            </unit>
            {% endfor %}
        </interface>
        {% endfor %}
        <interface>
            <name>lo0</name>
            <unit>
                <name>0</name>
                <family>
                    <inet>
                        <address>
                            <name>{{ host.loopback.ip_address }}</name>
                            <primary/>
                        </address>
                        <address>
                            <name>{{ host.protocols.pim.rp }}</name>
                        </address>
                    </inet>
                </family>
            </unit>
        </interface>
    </interfaces>
    <routing-options>
        <router-id>{{ host.loopback.ip_address.split('/')[0] }}</router-id>
        <autonomous-system>
            <as-number>{{ host.local_as }}</as-number>
        </autonomous-system>
        <forwarding-table>
            <export>PFE-LB</export>
        </forwarding-table>
    </routing-options>
    <policy-options>
        <policy-statement>
            <name>PFE-LB</name>
            <then>
                <load-balance>
                    <per-packet />
                </load-balance>
            </then>
        </policy-statement>
        <policy-statement>
            <name>fabric-out</name>
            <term>
                <name>direct</name>
                <from>
                    <protocol>direct</protocol>
                </from>
                <then>
                    <next-hop>
                        <self/>
                    </next-hop>
                    <accept/>
                </then>
            </term>
            <term>
                <name>pim</name>
                <from>
                    <route-filter>
                        <address>{{ host.protocols.pim.rp }}/32</address>
                        <exact/>
                    </route-filter>
                </from>
                <then>
                    <accept/>
                </then>
            </term>
        </policy-statement>
    </policy-options>
    <protocols>
        <bgp>
            <log-updown />
            <graceful-restart></graceful-restart>
            <export>fabric-out</export>
            {% for g in host.protocols.bgp.groups %}
            <group>
                <name>{{ g.name }}</name>
                <type>{{ g.type }}</type>
                <mtu-discovery />
                <multipath>
                    <multiple-as />
                </multipath>
                {% for n in g.neighbors %}
                <neighbor>
                    <name>{{ n.name }}</name>
                    <peer-as>{{ n.peer_as }}</peer-as>
                </neighbor>
                {% endfor %}
            </group>
            {% endfor %}
        </bgp>
        <pim>
            <rp>
                <local>
                    <family>
                        <inet>
                            <address>{{ host.protocols.pim.rp }}</address>
                            <anycast-pim>
                              <rp-set>
                                <address>
                                  <name>{{ host.protocols.pim.anycast_rp }}</name>
                                </address>
                              </rp-set>
                              <local-address>{{ host.loopback.ip_address.split('/')[0] }}</local-address>
                            </anycast-pim>
                        </inet>
                    </family>
                </local>
            </rp>
            {% for i in host.protocols.pim.interfaces %}
            <interface>
                <name>{{ i.name }}</name>
                <mode>{{ i.mode }}</mode>
            </interface>
            {% endfor %}
        </pim>
    </protocols>
</configuration>
